Я подготовлю примеры кода для выполнения лабораторной работы. Покажу ключевые фрагменты для каждого этапа.

5.1 Создание структуры проектов

5.1.1-5.1.2 Веб-API проект (Program.cs)

```csharp
using Microsoft.EntityFrameworkCore;
using DatabaseLibrary;

var builder = WebApplication.CreateBuilder(args);

builder.Services.AddControllers();
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen();

// Добавление контекста БД
builder.Services.AddDbContext<CinemaContext>(options =>
    options.UseSqlite(builder.Configuration.GetConnectionString("DefaultConnection")));

var app = builder.Build();

if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
    // Добавление Scalar
    app.MapScalarApiReference();
}

app.UseHttpsRedirection();
app.UseAuthorization();
app.MapControllers();

app.Run();
```

5.1.3 DatabaseLibrary (модели данных)

```csharp
using Microsoft.EntityFrameworkCore;

public class CinemaContext : DbContext
{
    public CinemaContext(DbContextOptions<CinemaContext> options) : base(options) { }
    
    public DbSet<Film> Films { get; set; }
    public DbSet<Genre> Genres { get; set; }
    public DbSet<Visitor> Visitors { get; set; }
    public DbSet<Ticket> Tickets { get; set; }
}

public class Film
{
    public int Id { get; set; }
    public string Title { get; set; }
    public int Duration { get; set; }
    public int GenreId { get; set; }
    public Genre Genre { get; set; }
}

public class Genre
{
    public int Id { get; set; }
    public string Name { get; set; }
    public List<Film> Films { get; set; } = new();
}

public class Visitor
{
    public int Id { get; set; }
    public string Name { get; set; }
    public string Email { get; set; }
    public List<Ticket> Tickets { get; set; } = new();
}

public class Ticket
{
    public int Id { get; set; }
    public int FilmId { get; set; }
    public int VisitorId { get; set; }
    public DateTime SessionTime { get; set; }
    public decimal Price { get; set; }
    public Film Film { get; set; }
    public Visitor Visitor { get; set; }
}
```

5.1.4 Контроллер для Film

```csharp
[ApiController]
[Route("api/[controller]")]
public class FilmsController : ControllerBase
{
    private readonly CinemaContext _context;

    public FilmsController(CinemaContext context)
    {
        _context = context;
    }

    [HttpGet]
    public async Task<ActionResult<IEnumerable<Film>>> GetFilms()
    {
        return await _context.Films.Include(f => f.Genre).ToListAsync();
    }

    [HttpGet("{id}")]
    public async Task<ActionResult<Film>> GetFilm(int id)
    {
        var film = await _context.Films.Include(f => f.Genre)
            .FirstOrDefaultAsync(f => f.Id == id);

        if (film == null)
            return NotFound();

        return film;
    }

    [HttpPost]
    public async Task<ActionResult<Film>> PostFilm(Film film)
    {
        _context.Films.Add(film);
        await _context.SaveChangesAsync();
        return CreatedAtAction(nameof(GetFilm), new { id = film.Id }, film);
    }

    [HttpPut("{id}")]
    public async Task<IActionResult> PutFilm(int id, Film film)
    {
        if (id != film.Id)
            return BadRequest();

        _context.Entry(film).State = EntityState.Modified;

        try
        {
            await _context.SaveChangesAsync();
        }
        catch (DbUpdateConcurrencyException)
        {
            if (!FilmExists(id))
                return NotFound();
            throw;
        }

        return NoContent();
    }

    [HttpDelete("{id}")]
    public async Task<IActionResult> DeleteFilm(int id)
    {
        var film = await _context.Films.FindAsync(id);
        if (film == null)
            return NotFound();

        _context.Films.Remove(film);
        await _context.SaveChangesAsync();
        return NoContent();
    }

    private bool FilmExists(int id) => _context.Films.Any(e => e.Id == id);
}
```

5.2 Автоматическая сериализация/десериализация

FilmService.cs в ApiServicesLibrary

```csharp
using System.Text.Json;

public class FilmService
{
    private readonly HttpClient _httpClient;
    private readonly string _baseUrl = "https://localhost:7000/api/films";

    public FilmService(HttpClient httpClient)
    {
        _httpClient = httpClient;
    }

    // Получение всех фильмов
    public async Task<List<Film>> GetFilmsAsync()
    {
        var response = await _httpClient.GetAsync(_baseUrl);
        response.EnsureSuccessStatusCode();
        
        var films = await response.Content.ReadFromJsonAsync<List<Film>>();
        return films ?? new List<Film>();
    }

    // Получение фильма по ID
    public async Task<Film> GetFilmAsync(int id)
    {
        var response = await _httpClient.GetAsync($"{_baseUrl}/{id}");
        response.EnsureSuccessStatusCode();
        
        return await response.Content.ReadFromJsonAsync<Film>() 
            ?? throw new Exception("Film not found");
    }

    // Создание фильма
    public async Task<Film> CreateFilmAsync(Film film)
    {
        var response = await _httpClient.PostAsJsonAsync(_baseUrl, film);
        response.EnsureSuccessStatusCode();
        
        return await response.Content.ReadFromJsonAsync<Film>() 
            ?? throw new Exception("Failed to create film");
    }

    // Обновление фильма
    public async Task UpdateFilmAsync(int id, Film film)
    {
        var response = await _httpClient.PutAsJsonAsync($"{_baseUrl}/{id}", film);
        response.EnsureSuccessStatusCode();
    }

    // Удаление фильма
    public async Task DeleteFilmAsync(int id)
    {
        var response = await _httpClient.DeleteAsync($"{_baseUrl}/{id}");
        response.EnsureSuccessStatusCode();
    }
}
```

5.3 Явная сериализация/десериализация

GenreService.cs в ApiServicesLibrary

```csharp
using System.Text;
using System.Text.Json;

public class GenreService
{
    private readonly HttpClient _httpClient;
    private readonly string _baseUrl = "https://localhost:7000/api/genres";
    private readonly JsonSerializerOptions _jsonOptions;

    public GenreService(HttpClient httpClient)
    {
        _httpClient = httpClient;
        _jsonOptions = new JsonSerializerOptions
        {
            PropertyNamingPolicy = JsonNamingPolicy.CamelCase,
            PropertyNameCaseInsensitive = true
        };
    }

    // Получение всех жанров (явная десериализация)
    public async Task<List<Genre>> GetGenresAsync()
    {
        var response = await _httpClient.GetAsync(_baseUrl);
        response.EnsureSuccessStatusCode();
        
        var content = await response.Content.ReadAsStringAsync();
        return JsonSerializer.Deserialize<List<Genre>>(content, _jsonOptions) 
            ?? new List<Genre>();
    }

    // Получение жанра по ID
    public async Task<Genre> GetGenreAsync(int id)
    {
        var response = await _httpClient.GetAsync($"{_baseUrl}/{id}");
        response.EnsureSuccessStatusCode();
        
        var content = await response.Content.ReadAsStringAsync();
        return JsonSerializer.Deserialize<Genre>(content, _jsonOptions) 
            ?? throw new Exception("Genre not found");
    }

    // Создание жанра (явная сериализация)
    public async Task<Genre> CreateGenreAsync(Genre genre)
    {
        var json = JsonSerializer.Serialize(genre, _jsonOptions);
        var content = new StringContent(json, Encoding.UTF8, "application/json");
        
        var response = await _httpClient.PostAsync(_baseUrl, content);
        response.EnsureSuccessStatusCode();
        
        var responseContent = await response.Content.ReadAsStringAsync();
        return JsonSerializer.Deserialize<Genre>(responseContent, _jsonOptions) 
            ?? throw new Exception("Failed to create genre");
    }

    // Обновление жанра
    public async Task UpdateGenreAsync(int id, Genre genre)
    {
        var json = JsonSerializer.Serialize(genre, _jsonOptions);
        var content = new StringContent(json, Encoding.UTF8, "application/json");
        
        var response = await _httpClient.PutAsync($"{_baseUrl}/{id}", content);
        response.EnsureSuccessStatusCode();
    }
}
```

5.4 Обработка статус-кодов при чтении

VisitorService.cs в ApiServicesLibrary

```csharp
public class VisitorService
{
    private readonly HttpClient _httpClient;
    private readonly string _baseUrl = "https://localhost:7000/api/visitors";

    public VisitorService(HttpClient httpClient)
    {
        _httpClient = httpClient;
    }

    // Получение посетителя по ID с обработкой кодов
    public async Task<Visitor?> GetVisitorAsync(int id)
    {
        var response = await _httpClient.GetAsync($"{_baseUrl}/{id}");
        
        if (response.StatusCode == HttpStatusCode.NotFound)
            return null;
            
        if (!response.IsSuccessStatusCode)
            throw new HttpRequestException($"Error: {response.StatusCode}");
        
        return await response.Content.ReadFromJsonAsync<Visitor>();
    }

    // Получение всех посетителей с обработкой кодов
    public async Task<List<Visitor>> GetVisitorsAsync()
    {
        var response = await _httpClient.GetAsync(_baseUrl);
        
        return response.StatusCode switch
        {
            HttpStatusCode.OK => await response.Content.ReadFromJsonAsync<List<Visitor>>() 
                                ?? new List<Visitor>(),
            HttpStatusCode.NoContent => new List<Visitor>(),
            HttpStatusCode.NotFound => throw new Exception("Ресурс не найден"),
            _ when !response.IsSuccessStatusCode => 
                throw new HttpRequestException($"Error: {response.StatusCode}"),
            _ => new List<Visitor>()
        };
    }
}
```

5.5 Обработка статус-кодов при записи

TicketService.cs в ApiServicesLibrary

```csharp
public class TicketService
{
    private readonly HttpClient _httpClient;
    private readonly string _baseUrl = "https://localhost:7000/api/tickets";

    public TicketService(HttpClient httpClient)
    {
        _httpClient = httpClient;
    }

    // Создание билета с обработкой кодов
    public async Task<Ticket> CreateTicketAsync(Ticket ticket)
    {
        var response = await _httpClient.PostAsJsonAsync(_baseUrl, ticket);
        
        if (response.StatusCode == HttpStatusCode.BadRequest)
            throw new ArgumentException("Invalid ticket data");
            
        if (response.StatusCode == HttpStatusCode.Conflict)
            throw new InvalidOperationException("Ticket already exists");
            
        if (!response.IsSuccessStatusCode)
            throw new HttpRequestException($"Error: {response.StatusCode}");
        
        // Возврат созданного ресурса для успешных кодов
        if (response.IsSuccessStatusCode)
            return await response.Content.ReadFromJsonAsync<Ticket>() 
                ?? throw new Exception("Failed to create ticket");
        
        throw new Exception("Unexpected response");
    }

    // Обновление билета с обработкой кодов
    public async Task<bool> UpdateTicketAsync(int id, Ticket ticket)
    {
        var response = await _httpClient.PutAsJsonAsync($"{_baseUrl}/{id}", ticket);
        
        if (response.StatusCode == HttpStatusCode.BadRequest)
            throw new ArgumentException("Invalid ticket data");
            
        if (response.StatusCode == HttpStatusCode.NotFound)
            return false;
            
        if (!response.IsSuccessStatusCode)
            throw new HttpRequestException($"Error: {response.StatusCode}");
        
        // Возврат true для успешных кодов (200, 204 и др.)
        return response.IsSuccessStatusCode;
    }
}
```

Консольное приложение для тестирования

```csharp
using ApiServicesLibrary;

class Program
{
    static async Task Main(string[] args)
    {
        var httpClient = new HttpClient();
        
        // Тестирование FilmService
        var filmService = new FilmService(httpClient);
        
        try
        {
            // Получение всех фильмов
            var films = await filmService.GetFilmsAsync();
            Console.WriteLine($"Found {films.Count} films");
            
            // Создание нового фильма
            var newFilm = new Film { Title = "New Film", Duration = 120, GenreId = 1 };
            var createdFilm = await filmService.CreateFilmAsync(newFilm);
            Console.WriteLine($"Created film: {createdFilm.Title}");
            
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
        
        Console.ReadLine();
    }
}
```

Ответы на контрольные вопросы

8.1 Что такое JSON и для чего он используется?

JSON (JavaScript Object Notation) - текстовый формат обмена данными. Используется для передачи структурированных данных между клиентом и сервером в веб-приложениях.

8.2 Что такое HttpClient и для чего он используется?

HttpClient - класс в .NET для отправки HTTP-запросов и получения HTTP-ответов от веб-ресурсов. Используется для взаимодействия с веб-API.

8.3 Как вызывать методы веб-API без явной сериализации/десериализации?

Используя методы расширения:

```csharp
var response = await client.GetFromJsonAsync<T>("url");
var response = await client.PostAsJsonAsync("url", object);
```

8.4 Как вызывать методы веб-API с явной сериализацией/десериализацией?

```csharp
// Сериализация
var json = JsonSerializer.Serialize(object);
var content = new StringContent(json, Encoding.UTF8, "application/json");

// Десериализация  
var responseContent = await response.Content.ReadAsStringAsync();
var result = JsonSerializer.Deserialize<T>(responseContent);
```

8.5 Как добавить генерацию исключений в случае неуспешных кодов ответа?

```csharp
response.EnsureSuccessStatusCode();
// или
if (!response.IsSuccessStatusCode)
    throw new HttpRequestException($"Error: {response.StatusCode}");
```

8.6 Как реализовать обработку разных кодов ответа?

Используя конструкцию switch или условные проверки:

```csharp
return response.StatusCode switch
{
    HttpStatusCode.OK => result,
    HttpStatusCode.NotFound => null,
    _ => throw new Exception("Unexpected status code")
};
```

Этот код демонстрирует основные подходы к работе с веб-API, обработке статус-кодов и сериализации данных в соответствии с требованиями лабораторной работы.